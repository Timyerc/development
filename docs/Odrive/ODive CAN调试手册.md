# ODrive CAN调试手册

上位机获取[Home: PEAK-System](https://www.peak-system.com/)

备注：CAN的通信协议为自定义协议，不适用ODrive官方的固件

## 1、准备工作

**1、搭建硬件电路：连接电机、电阻、USB、CAN模块、电源**

**2、使用USB-CAN模块连接电脑和ODrive开发板**

**3、波特率设置为100kbit/s**

**4、导入常用的CAN命令**

<img title="" src="image\OdriveCAN2.png" alt="image" width="549">

## 2、CAN的常用命令以及异常处理机制介绍

![image](image\OdriveCAN1.png)

![image](image\OdriveCAN3.png)

**CAN的速度返回机制**

```
驱动器接收到状态访问指令时，且一切正常，会返回状态码09 + 电机位置 + 电机转速

发送：001h 06 01                //获取电机0当前状态
返回：002h 09 00 00 00 00       //状态码 + 位置(2Byte) + 转速(2Byte)

发送：001h 06 02                //获取电机1当前状态
返回：003h 09 00 00 00 00       //状态码 + 位置(2Byte) + 转速(2Byte)
```

**CAN错误返回机制**

```
当驱动器出现异常时，状态码将会变为对应的错误状态 + 错误码

发送：001h 06 01                //获取电机0当前状态
返回：002h 0x 00 00 00 00       //状态码 + 错误码(4Byte)

发送：001h 06 02                //获取电机1当前状态
返回：003h 0x 00 00 00 00       //状态码 + 错误码(4Byte)
```

Odriv常用的错误类别如下：

![image](image\OdriveCAN4.png)

**CAN的保活机制**

can需要不停的接收命令，来确保线路连接正常。在设定时间(700ms以内)驱动器需要接收到新的数据包，否则将会自动停机。

**CAN的错误清除机制**

```
发送：001h C0 00 00            //清除M0的错误，并设置转速为0
发送：001h C0 00 01            //清除M1的错误，并设置转速为0
```

**CAN的过流保护查询及设置**

```
查询电机过流的判定时间和阈值

发送：001h CB 00               //查询M0的判定时间和电流阈值
返回：002h CB 00 00 1E 03 E8   //功能码 + 电机类型 + 保护时间 + 保护电流

发送：001h CB 01               //查询M1的判定时间和电流阈值
返回：003h CB 00 00 1E 03 E8   //功能码 + 电机类型 + 保护时间 + 保护电流
```

```
设置电机过流的判定时间和阈值

发送：001h CA 00 00 1E 03 E8   //设置M0的电流阈值(30*100ms)和时间
返回：002h CA 00 00 1E 03 E8   //功能码 + 电机类型 + 保护时间 + 保护电流

发送：001h CA 01 00 1E 03 E8   //设置M1的电流阈值和时间
返回：003h CA 00 00 1E 03 E8   //功能码 + 电机类型 + 保护时间 + 保护电流
```

**CAN的速度设置**

```
通常情况下，odrive开发板在配置完成后，会自动进入闭环模式。

发送：001h 01 80 00 80 00      //转速01 + M0转速为0(2Byte) + M1转速为0(2Byte)
发送：001h 01 00 00 FF FF      //转速01 + M0转速为-1(2Byte) + M1转速为1(2Byte)


```
